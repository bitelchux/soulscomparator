var e=new Firebase("https://darksoulscomparator.firebaseIO.com");var t={armors:[],shields:[],weapons:[],pieces:{head:[],chest:[],hands:[],legs:[]}};var r=null;var a={1:null,2:null};e.child("ds1/indexes").on("value",function(e){data=e.val();t.weapons=data.weapons[y(data.weapons)];t.armors=data.armors[y(data.armors)];t.shields=data.shields[y(data.shields)];t.pieces=data.pieces[y(data.pieces)];s();$("#type").removeAttr("disabled");$("#type").selectpicker("refresh");$("select.basic-comparator").on("change",function(e){var r=unescape($(this).val());var a=$(this).attr("data-item");var i=$("#type").val();var n=t[i].filter(function(e){return y(e)===r})[0][r];l(a,n)});$("select.detailed-comparator").on("change",function(e){var r=unescape($(this).val());var a=$(this).attr("data-item");var i=$(this).attr("data-piece");var n=0;if(r!=="naked"){n=t.pieces[i].filter(function(e){return y(e)===r})[0][r]}c(a,i,n)})});$(document).ready(function(){b();$("#type").on("change",function(e){r=$(this).val();$("#comparison").html("");$("#by-widgets").hide();$("#by").selectpicker("val",null);$("#detailed-widgets").hide();$("#basic-widgets").hide();b();if(r==="armors"){n()}else{i()}});$(".set-comparator").on("change",function(e){var r=$(this).val();var a=$(this).attr("data-item");if(r==="custom"){v(a)}else{r=unescape(r);var i=t.armors.filter(function(e){return y(e)===r})[0][r];b(a);o(a,i)}});$("button#compare").on("click",function(e){g();var t=unescape($(this).val());if(r==="armors"){var a=d().then(function(e){var t=new x({el:"#comparison"}).render(e[0],e[1]);f()}).catch(function(e){alert(e);f()})}else{var a=u().then(function(e){var t=r==="shields";var a=new A({el:"#comparison"}).render(e[0],e[1],t);f()}).catch(function(e){alert(e);f()})}})});Handlebars.registerHelper("toTitleCase",function(e){return e.split("_").map(function(e){return e[0].toUpperCase()+e.slice(1,e.length)}).join(" ")});function i(){var e="";t[r].map(function(e){return y(e)}).sort().forEach(function(t){e+='<option value="'+escape(t)+'">'+t+"</option>"});$("select.basic-comparator").html(e);$("select.basic-comparator").selectpicker("refresh");$("#basic-widgets").show()}function n(){var e='<option value="custom">Custom</option>';e+='<optgroup label="Sets">';t[r].map(function(e){return y(e)}).sort().forEach(function(t){e+='<option value="'+escape(t)+'">'+t+"</option>"});e+="</optgroup>";$("select.set-comparator").html(e);$("select.set-comparator").selectpicker("refresh");$("#by-widgets").show();$("#detailed-widgets").show()}function s(){Object.keys(t.pieces).forEach(function(e){var r='<option value="naked">Naked</option>';var a=t.pieces[e].map(function(e){return y(e)}).sort();a.forEach(function(e){r+='<option value="'+escape(e)+'">'+e+"</option>"});var i=$('select.detailed-comparator[data-piece="'+e+'"]');i.html(r);i.selectpicker("refresh")})}function l(e,t){var r='<option value="0" selected>0</option>';for(var a=1;a<=t;a++){r+='<option value="'+a+'">+'+a+"</option>"}var i=$('select.basic-level[data-level="'+e+'"]');i.html(r);i.selectpicker("refresh")}function c(e,t,r){var a='<option value="0" selected>0</option>';for(var i=1;i<=r;i++){a+='<option value="'+i+'">+'+i+"</option>"}var n=$('select.detailed-level[data-level="'+e+'"][data-piece="'+t+'"]');n.html(a);n.selectpicker("refresh")}function o(e,t){var r='<option value="0" selected>0</option>';for(var a=1;a<=t;a++){r+='<option value="'+a+'">+'+a+"</option>"}var i=$('select.set-level[data-level="'+e+'"]');i.html(r);i.selectpicker("refresh")}function u(){var t=unescape($('.basic-comparator[data-item="1"]').selectpicker("val"));var a=unescape($('.basic-comparator[data-item="2"]').selectpicker("val"));var i=unescape($('.basic-level[data-level="1"]').selectpicker("val"));var n=unescape($('.basic-level[data-level="2"]').selectpicker("val"));return new Promise(function(s,l){var c,o;var u=i!=="0"?t+" +"+i:t;var d=n!=="0"?a+" +"+n:a;e.child("ds1/"+r).orderByChild("name").equalTo(u).once("value",function(e){var t=e.val();c=t[Object.keys(t)[0]];if(c&&o)s([c,o])});e.child("ds1/"+r).orderByChild("name").equalTo(d).once("value",function(e){var t=e.val();o=t[Object.keys(t)[0]];if(c&&o)s([c,o])})})}function d(){var e=unescape($('.set-comparator[data-item="1"]').selectpicker("val"));var t=unescape($('.set-comparator[data-item="2"]').selectpicker("val"));return new Promise(function(r,a){var i,n;if(e==="custom"){var s=h(p(1))}else{var l=$('select.set-level[data-level="1"]').selectpicker("val");var c=l!=="0"?e+" +"+l:e;var s=m(c)}s.then(function(e){i=e;if(i&&n)r([i,n])});if(t==="custom"){var o=h(p(2))}else{var l=$('select.set-level[data-level="2"]').selectpicker("val");var u=l!=="0"?t+" +"+l:t;var o=m(u)}o.then(function(e){n=e;if(i&&n)r([i,n])})})}function m(t){return new Promise(function(r,a){e.child("ds1/armors").orderByChild("set").equalTo(t).once("value",function(e){var t=e.val();var a={pieces:[]};Object.keys(t).forEach(function(e){a.pieces.push(t[e])});r(a)})})}function h(r){return new Promise(function(a,i){var n={pieces:[]};Object.keys(t.pieces).forEach(function(t){if(r[t]&&r[t]!=="naked"){var i=unescape(r[t]);var s=new Promise(function(t,r){e.child("ds1/armors").orderByChild("name").equalTo(i).once("value",function(e){var r=e.val();var a=Object.keys(r)[0];t(r[a])})});s.then(function(e){n.pieces.push(e);if(n.pieces.length===Object.keys(r).length){a(n)}})}})})}function p(e){var r={};Object.keys(t.pieces).forEach(function(t){var a=$('select.detailed-comparator[data-item="'+e+'"][data-piece="'+t+'"]').selectpicker("val");var i=$('select.detailed-level[data-level="'+e+'"][data-piece="'+t+'"]').selectpicker("val");if(a&&a!=="naked"){r[t]=i!=="0"?a+" +"+i:a}});return r}function f(){$("button#compare").removeAttr("disabled")}function g(e){$("button#compare").attr("disabled","")}function v(e){var t=e?'[data-item="'+e+'"]':"";var r=$("select.detailed-comparator"+t);r.removeAttr("disabled");r.selectpicker("refresh");var a=e?'[data-level="'+e+'"]':"";r=$("select.detailed-level"+a);r.removeAttr("disabled");r.selectpicker("refresh");var i=$("select.set-level"+a);i.attr("disabled","");i.selectpicker("refresh")}function b(e){var t=e?'[data-item="'+e+'"]':"";var r=$("select.detailed-comparator"+t);r.attr("disabled","");r.selectpicker("refresh");var a=e?'[data-level="'+e+'"]':"";r=$("select.detailed-level"+a);r.attr("disabled","");r.selectpicker("refresh");var i=$("select.set-level"+a);i.removeAttr("disabled");i.selectpicker("refresh")}function y(e){return Object.keys(e)[0]}var x=Backbone.View.extend({initialize:function(){this.contentTemplate=Handlebars.compile($("#content-template").html());this.statsBoxTemplate=Handlebars.compile($("#stats-box-template").html())},calculateSetStats:function(e){var t={elemental_defense:{fire:0,lightning:0,magic:0},physical_defense:{regular:0,strike:0,slash:0,thrust:0},resistances:{bleed:0,poison:0,curse:0},weight:0,poise:0,durability:0,name:""};for(var r=0;r<e.pieces.length;r++){var a=e.pieces[r];t.elemental_defense.fire+=parseFloat(a.elemental_defense.fire);t.elemental_defense.lightning+=parseFloat(a.elemental_defense.lightning);t.elemental_defense.magic+=parseFloat(a.elemental_defense.magic);t.physical_defense.regular+=parseFloat(a.physical_defense.regular);t.physical_defense.strike+=parseFloat(a.physical_defense.strike);t.physical_defense.slash+=parseFloat(a.physical_defense.slash);t.physical_defense.thrust+=parseFloat(a.physical_defense.thrust);t.resistances.bleed+=parseFloat(a.resistances.bleed);t.resistances.poison+=parseFloat(a.resistances.poison);t.resistances.curse+=parseFloat(a.resistances.curse);t.weight+=parseFloat(a.weight);t.poise+=parseFloat(a.poise);t.durability+=parseInt(a.durability);if(t.name===""){t.name=a.set}else if(a.set!==t.name){t.name="Custom"}t.type=a.type}return t},renderChart:function(e,t){var r={chart:{renderTo:"chart",polar:true,type:"line"},title:{text:e.name+" vs "+t.name,x:-80},xAxis:{categories:["Regular Def","Strike Def","Slash Def","Thrust Def","Fire Def","Magic Def","Lightning Def","Bleed Res","Poison Res","Curse Res","Poise","Weight"],lineWidth:0},yAxis:{gridLineInterpolation:"polygon",lineWidth:0,min:0},legend:{align:"right",verticalAlign:"bottom",layout:"vertical"},series:[{name:e.name,data:[e.physical_defense.regular,e.physical_defense.strike,e.physical_defense.slash,e.physical_defense.thrust,e.elemental_defense.fire,e.elemental_defense.magic,e.elemental_defense.lightning,e.resistances.bleed,e.resistances.poison,e.resistances.curse,e.poise,e.weight],pointPlacement:"on"},{name:t.name,data:[t.physical_defense.regular,t.physical_defense.strike,t.physical_defense.slash,t.physical_defense.thrust,t.elemental_defense.fire,t.elemental_defense.magic,t.elemental_defense.lightning,t.resistances.bleed,t.resistances.poison,t.resistances.curse,t.poise,t.weight],pointPlacement:"on"}]};var a=new Highcharts.Chart(r)},renderSets:function(e,t){var r=k.renderImage(e,"type");var a=k.renderImage(t,"type");var i="";i+=this.renderPhysicalDefense(e,t);i+=this.renderElementalDefense(e,t);i+=this.renderResistances(e,t);i+=this.renderOthers(e,t);return this.contentTemplate({body:i,description1:r,description2:a})},renderPiece:function(e){var t="";var r=_.find(this.armor1.pieces,{piece:e})||{};var a=_.find(this.armor2.pieces,{piece:e})||{};var i=k.renderImage(r,"type");var n=k.renderImage(a,"type");var t="";t+=this.renderPhysicalDefense(r,a);t+=this.renderElementalDefense(r,a);t+=this.renderResistances(r,a);t+=this.renderOthers(r,a);return this.contentTemplate({body:t,description1:i,description2:n})},renderPhysicalDefense:function(e,t){var r="",a=e.physical_defense||{},i=t.physical_defense||{};r+=k.renderAttribute("regular_defense","Regular",a.regular,i.regular);r+=k.renderAttribute("strike_defense","Strike",a.strike,i.strike);r+=k.renderAttribute("slash_defense","Slashsh",a.slash,i.slash);r+=k.renderAttribute("thrust_defense","Thrust",a.thrust,i.thrust);return this.statsBoxTemplate({title:"Physical Defense",name1:e.name,name2:t.name,stats:r})},renderElementalDefense:function(e,t){var r="",a=e.elemental_defense||{},i=t.elemental_defense||{};r+=k.renderAttribute("fire_defense","Fire",a.fire,i.fire);r+=k.renderAttribute("magic_defense","Magic",a.magic,i.magic);r+=k.renderAttribute("lightning_defense","Lightning",a.lightning,i.lightning);return this.statsBoxTemplate({title:"Elemental Defense",name1:e.name,name2:t.name,stats:r})},renderResistances:function(e,t){var r="",a=e.resistances||{},i=t.resistances||{};r+=k.renderAttribute("bleed","Bleed",a.bleed,i.bleed);r+=k.renderAttribute("poison","Poison",a.poison,i.poison);r+=k.renderAttribute("curse","Curse",a.curse,i.curse);return this.statsBoxTemplate({title:"Resistances",name1:e.name,name2:t.name,stats:r})},renderOthers:function(e,t){var r="";r+=k.renderAttribute("poise","Poise",e.poise,t.poise);r+=k.renderAttribute("weight","Weight",e.weight,t.weight,{isNegative:true});r+=k.renderAttribute("durability","Durability",e.durability,t.durability,{isInteger:true});return this.statsBoxTemplate({title:"Others",name1:e.name,name2:t.name,stats:r})},render:function(e,t){this.armor1=e;this.armor2=t;this.set1=this.calculateSetStats(this.armor1);this.set2=this.calculateSetStats(this.armor2);var r=this.renderSets(this.set1,this.set2);r+=this.renderPiece("Head");r+=this.renderPiece("Chest");r+=this.renderPiece("Hands");r+=this.renderPiece("Legs");this.$el.html(r)}});var A=Backbone.View.extend({initialize:function(){this.contentTemplate=Handlebars.compile($("#content-template").html());this.statsBoxTemplate=Handlebars.compile($("#stats-box-template").html())},parseNumber:function(e){if(e==="-"){return 0}else if(e==="S"){return 6}else if(e==="A"){return 5}else if(e==="B"){return 4}else if(e==="C"){return 3}else if(e==="D"){return 2}else if(e==="E"){return 1}else{attempt=parseFloat(e);if(isNaN(attempt)){return 0}return attempt}},convertForChart:function(e){return[this.parseNumber(e.stats.physical_damage),this.parseNumber(e.stats.magic_damage),this.parseNumber(e.stats.fire_damage),this.parseNumber(e.stats.lightning_damage),this.parseNumber(e.stats.critical),this.parseNumber(e.param_bonus.strength),this.parseNumber(e.param_bonus.dexterity),this.parseNumber(e.param_bonus.intelligence),this.parseNumber(e.param_bonus.faith),this.parseNumber(e.req_param.strength),this.parseNumber(e.req_param.dexterity),this.parseNumber(e.req_param.intelligence),this.parseNumber(e.req_param.faith),this.parseNumber(e.aux_effect.bleed),this.parseNumber(e.aux_effect.toxic),this.parseNumber(e.aux_effect.occult),this.parseNumber(e.aux_effect.divine),this.parseNumber(e.weight)]},renderChart:function(e,t){var r={chart:{renderTo:"chart",type:"bar"},title:{text:null},credits:{enabled:false},xAxis:{categories:["Physical Dmg","Magic Dmg","Fire Dmg","Lightning Dmg","Critical","Bonus Strengh","Bonus Dexterity","Bonus Intelligence","Bonus Faith","Req Strength","Req Dexterity","Req Intelligence","Req Faith","Bleed","Toxic","Occult","Divine","Weight"]},legend:{align:"center",verticalAlign:"top",layout:"vertical"},series:[{name:e.name,data:this.convertForChart(e)},{name:t.name,data:this.convertForChart(t)}]};console.log("opts",r);var a=new Highcharts.Chart(r)},renderDamageStats:function(e,t){var r="",a=e.stats,i=t.stats;r+=k.renderAttribute("physical_damage","Regular",a.physical_damage,i.physical_damage);r+=k.renderAttribute("magic_damage","Magic",a.magic_damage,i.magic_damage);r+=k.renderAttribute("fire_damage","Fire",a.fire_damage,i.fire_damage);r+=k.renderAttribute("lightning_damage","Lightning",a.lightning_damage,i.lightning_damage);r+=k.renderAttribute("critical","Critical",a.critical,i.critical);return this.statsBoxTemplate({title:"Damage",name1:e.name,name2:t.name,stats:r})},renderReductionStats:function(e,t){var r="",a=e.stats,i=t.stats;r+=k.renderAttribute("physical_reduction","Physical",a.physical_reduction,i.physical_reduction);r+=k.renderAttribute("magic_reduction","Magic",a.magic_reduction,i.magic_reduction);r+=k.renderAttribute("fire_reduction","Fire",a.fire_reduction,i.fire_reduction);r+=k.renderAttribute("lightning_reduction","Lightning",a.lightning_reduction,i.lightning_reduction);r+=k.renderAttribute("stability","Stability",a.stability,i.stability);return this.statsBoxTemplate({title:"Reduction",name1:e.name,name2:t.name,stats:r})},renderParamBonus:function(e,t){var r="",a=e.param_bonus,i=t.param_bonus;r+=k.renderAttribute("strength","Strength",a.strength,i.strength,{isNegative:true,isString:true,invertSymbols:true});r+=k.renderAttribute("dexterity","Dexterity",a.dexterity,i.dexterity,{isNegative:true,isString:true,invertSymbols:true});r+=k.renderAttribute("intelligence","Intelligence",a.intelligence,i.intelligence,{isNegative:true,isString:true,invertSymbols:true});r+=k.renderAttribute("faith","Faith",a.faith,i.faith,{isNegative:true,isString:true,invertSymbols:true});return this.statsBoxTemplate({title:"Param Bonus",name1:e.name,name2:t.name,stats:r})},renderReqParams:function(e,t){var r="",a=e.req_param,i=t.req_param;r+=k.renderAttribute("strength","Strength",a.strength,i.strength,{isNegative:true,isInteger:true});r+=k.renderAttribute("dexterity","Dexterity",a.dexterity,i.dexterity,{isNegative:true,isInteger:true});r+=k.renderAttribute("intelligence","Intelligence",a.intelligence,i.intelligence,{isNegative:true,isInteger:true});r+=k.renderAttribute("faith","Faith",a.faith,i.faith,{isNegative:true,isInteger:true});return this.statsBoxTemplate({title:"Req Params",name1:e.name,name2:t.name,stats:r})},renderAuxEffects:function(e,t){var r="",a=e.aux_effect,i=t.aux_effect;r+=k.renderAttribute("bleed","Bleed",a.bleed,i.bleed,{isInteger:true});r+=k.renderAttribute("toxic","Toxic",a.toxic,i.toxic,{isInteger:true});r+=k.renderAttribute("occult","Occult",a.occult,i.occult,{isInteger:true});r+=k.renderAttribute("divine","Divine",a.divine,i.divine,{isInteger:true});return this.statsBoxTemplate({title:"Aux Effects",name1:e.name,name2:t.name,stats:r})},renderResistances:function(e,t){var r="",a=e.resistances,i=t.resistances;r+=k.renderAttribute("bleed","Bleed",a.bleed,i.bleed,{isPercentage:true});r+=k.renderAttribute("poison","Poison",a.poison,i.poison,{isPercentage:true});r+=k.renderAttribute("toxic","Toxic",a.toxic,i.toxic,{isPercentage:true});r+=k.renderAttribute("curse","Curse",a.curse,i.curse,{isPercentage:true});return this.statsBoxTemplate({title:"Resistances",name1:e.name,name2:t.name,stats:r})},renderOthers:function(e,t){var r="";r+=k.renderAttribute("weight","Weight",e.weight,t.weight,{isNegative:true});r+=k.renderAttribute("durability","Durability",e.durability,t.durability,{isInteger:true});if(e.magic_adjust||t.magic_adjust){r+=k.renderAttribute("magic_adjust","Magic Adjust",e.magic_adjust,t.magic_adjust,{isInteger:true,notIcon:true})}return this.statsBoxTemplate({title:"Others",name1:e.name,name2:t.name,stats:r})},render:function(e,t,r){var a=k.renderImage(e,"attack_type","weapon_type");var i=k.renderImage(t,"attack_type","weapon_type");var n="";n+=this.renderDamageStats(e,t);n+=this.renderReductionStats(e,t);n+=this.renderParamBonus(e,t);n+=this.renderReqParams(e,t);if(r){n+=this.renderResistances(e,t)}else{n+=this.renderAuxEffects(e,t)}n+=this.renderOthers(e,t);content=this.contentTemplate({body:n,description1:a,description2:i});this.$el.html(content)}});var k=function(){var e=Handlebars.compile($("#attribute-template").html());var t=Handlebars.compile($("#image-template").html());var r=["-","–","S","A","B","C","D","E"];var a=function(e,t){if(e!==t){if(e==="S"){return 1}else if(t==="S"){return-1}else if(e==="-"||t==="-"){return 0}else{if(e>t)return 1;if(e<t)return-1}}else{return 0}};return{renderAttribute:function(t,i,n,s,l){l=l||{};var c=color2="",o="=";if(l.isNegative){goodColor="red";badColor="blue"}else{goodColor="blue";badColor="red"}if(l.invertSymbols){biggerThanSymbol="<";lesserThanSymbol=">"}else{biggerThanSymbol=">";lesserThanSymbol="<"}if(!l.isString){n=n==="–"||n==="-"?0:parseFloat(n);s=s==="–"||s==="-"?0:parseFloat(s)}if(a(n,s)>0){c=goodColor;color2=badColor;o=biggerThanSymbol}else if(a(n,s)<0){c=badColor;color2=goodColor;o=lesserThanSymbol}if(!l.isInteger&&!l.isPercentage){n=r.indexOf(n)>=0?n:n.toFixed(1);s=r.indexOf(s)>=0?s:s.toFixed(1)}if(l.isPercentage){n=n+"%";s=s+"%"}var u={key:i,icon:{icon:t,caption:i},color1:c,color2:color2,value1:n,value2:s,symbol:o};if(l.notIcon)delete u.icon;return e(u)},renderImage:function(e,r,a){var i=e[r];var n=e[a];return t({name:unescape(e.name),source:e.image,title1:r,title2:a,type1:i,type2:n})},unescape:function(e){e=unescape(e);return e}}}();