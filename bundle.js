var e=new Firebase("https://darksoulscomparator.firebaseIO.com");var t={armors:[],shields:[],weapons:[],pieces:{head:[],chest:[],hands:[],legs:[]}};var r=null;var i={1:null,2:null};e.child("ds1/indexes").on("value",function(e){data=e.val();Object.keys(data.weapons).forEach(function(e){t.weapons=data.weapons[e];t.weapons.sort()});Object.keys(data.armors).forEach(function(e){t.armors=data.armors[e];t.armors.sort()});Object.keys(data.shields).forEach(function(e){t.shields=data.shields[e];t.shields.sort()});Object.keys(data.pieces).forEach(function(e){Object.keys(data.pieces[e]).forEach(function(r){t.pieces[r]=data.pieces[e][r];t.pieces[r].sort()})});s();console.log("indexes",t);$("#type").removeAttr("disabled");$("#type").selectpicker("refresh")});$(document).ready(function(){m();$("#type").on("change",function(e){r=$(this).val();$("#comparison").html("");$("#by-widgets").hide();$("#by").selectpicker("val",null);$("#detailed-widgets").hide();$("#basic-widgets").hide();m();if(r==="armors"){a()}else{n()}});$(".set-comparator").on("change",function(e){var t=$(this).val();var r=$(this).attr("data-item");if(t==="custom"){h(r)}else{m(r)}});$("button#compare").on("click",function(e){f();var t=unescape($(this).val());if(r==="armors"){var i=o().then(function(e){var t=new g({el:"#comparison"}).render(e[0],e[1]);p()}).catch(function(e){alert(e);p()})}else{var i=c().then(function(e){var t=new b({el:"#comparison"}).render(e[0],e[1]);p()}).catch(function(e){alert(e);p()})}})});Handlebars.registerHelper("toTitleCase",function(e){return e.split("_").map(function(e){return e[0].toUpperCase()+e.slice(1,e.length)}).join(" ")});function n(){var e="";t[r].forEach(function(t){e+='<option value="'+escape(t)+'">'+t+"</option>"});$("select.basic-comparator").html(e);$("select.basic-comparator").selectpicker("refresh");$("#basic-widgets").show()}function a(){var e='<option value="custom">Custom</option>';e+='<optgroup label="Sets">';t[r].forEach(function(t){e+='<option value="'+escape(t)+'">'+t+"</option>"});e+="</optgroup>";$("select.set-comparator").html(e);$("select.set-comparator").selectpicker("refresh");$("#by-widgets").show();$("#detailed-widgets").show()}function s(){Object.keys(t.pieces).forEach(function(e){var r='<option value="naked">Naked</option>';var i=t.pieces[e].map(function(e){return e.name}).sort();i.forEach(function(e){r+='<option value="'+escape(e)+'">'+e+"</option>"});var n=$("select."+e+"-comparator");n.html(r);n.selectpicker("refresh")})}function c(){var t=unescape($('.basic-comparator[data-item="1"]').selectpicker("val"));var i=unescape($('.basic-comparator[data-item="2"]').selectpicker("val"));return new Promise(function(n,a){var s,c;e.child("ds1/"+r).orderByChild("name").equalTo(t).once("value",function(e){var t=e.val();s=t[Object.keys(t)[0]];if(s&&c)n([s,c])});e.child("ds1/"+r).orderByChild("name").equalTo(i).once("value",function(e){var t=e.val();c=t[Object.keys(t)[0]];if(s&&c)n([s,c])})})}function o(){var e=unescape($('.set-comparator[data-item="1"]').selectpicker("val"));var t=unescape($('.set-comparator[data-item="2"]').selectpicker("val"));return new Promise(function(r,i){var n,a;if(e==="custom"){var s=u(d(1))}else{var s=l(e)}s.then(function(e){n=e;if(n&&a)r([n,a])});if(t==="custom"){var c=u(d(2))}else{var c=l(t)}c.then(function(e){a=e;if(n&&a)r([n,a])})})}function l(t){return new Promise(function(r,i){e.child("ds1/armors").orderByChild("set").equalTo(t).once("value",function(e){var t=e.val();var i={pieces:[]};Object.keys(t).forEach(function(e){i.pieces.push(t[e])});r(i)})})}function u(r){return new Promise(function(i,n){var a={pieces:[]};Object.keys(t.pieces).forEach(function(t){if(r[t]&&r[t]!=="naked"){var n=unescape(r[t]);console.log("searching",t,n);var s=new Promise(function(t,r){e.child("ds1/armors").orderByChild("name").equalTo(n).once("value",function(e){var r=e.val();console.log("data",r);var i=Object.keys(r)[0];console.log("key",i);t(r[i])})});s.then(function(e){a.pieces.push(e);if(a.pieces.length===Object.keys(r).length){i(a)}})}})})}function d(e){var r={};Object.keys(t.pieces).forEach(function(t){var i=$("select."+t+'-comparator[data-item="'+e+'"]').selectpicker("val");if(i&&i!=="naked"){r[t]=i}});return r}function p(){$("button#compare").removeAttr("disabled")}function f(e){$("button#compare").attr("disabled","")}function h(e){var t=e?'[data-item="'+e+'"]':"";var r=$("#detailed-widgets select"+t);r.removeAttr("disabled");r.selectpicker("refresh")}function m(e){var t=e?'[data-item="'+e+'"]':"";var r=$("#detailed-widgets select"+t);r.attr("disabled","");r.selectpicker("refresh")}var g=Backbone.View.extend({initialize:function(){this.bodyTemplate=Handlebars.compile($("#armor-template").html())},calculateSetStats:function(e){var t={elemental_defense:{fire:0,lightning:0,magic:0},physical_defense:{regular:0,strike:0,slash:0,thrust:0},resistances:{bleed:0,poison:0,curse:0},weight:0,poise:0,durability:0,name:""};for(var r=0;r<e.pieces.length;r++){var i=e.pieces[r];t.elemental_defense.fire+=parseFloat(i.elemental_defense.fire);t.elemental_defense.lightning+=parseFloat(i.elemental_defense.lightning);t.elemental_defense.magic+=parseFloat(i.elemental_defense.magic);t.physical_defense.regular+=parseFloat(i.physical_defense.regular);t.physical_defense.strike+=parseFloat(i.physical_defense.strike);t.physical_defense.slash+=parseFloat(i.physical_defense.slash);t.physical_defense.thrust+=parseFloat(i.physical_defense.thrust);t.resistances.bleed+=parseFloat(i.resistances.bleed);t.resistances.poison+=parseFloat(i.resistances.poison);t.resistances.curse+=parseFloat(i.resistances.curse);t.weight+=parseFloat(i.weight);t.poise+=parseFloat(i.poise);t.durability=parseInt(i.durability);if(t.name===""){t.name=i.set}else if(i.set!==t.name){t.name="Custom"}t.type=i.type}return t},renderSets:function(){var e="",t=this.calculateSetStats(this.armor1),r=this.calculateSetStats(this.armor2);e+=this.renderPhysicalDefenses(t.physical_defense,r.physical_defense);e+=this.renderElementalDefenses(t.elemental_defense,r.elemental_defense);e+=this.renderResistances(t.resistances,r.resistances);e+=v.renderAttribute("poise",t.poise,r.poise);e+=v.renderAttribute("weight",t.weight,r.weight,{isNegative:true});e+=v.renderAttribute("durability",t.durability,r.durability,{isInteger:true});e+=v.renderAttribute("type",t.type,r.type,{isString:true,notIcon:true});return this.bodyTemplate({body:e,piece:"Set",name1:v.unescape(t.name),name2:v.unescape(r.name)})},renderPiece:function(e){var t="",r=_.find(this.armor1.pieces,{piece:e})||{},i=_.find(this.armor2.pieces,{piece:e})||{};t+=v.renderImage(r,i);t+=this.renderPhysicalDefenses(r.physical_defense,i.physical_defense);t+=this.renderElementalDefenses(r.elemental_defense,i.elemental_defense);t+=this.renderResistances(r.resistances,i.resistances);t+=v.renderAttribute("poise",r.poise,i.poise);t+=v.renderAttribute("weight",r.weight,i.weight,{isNegative:true});t+=v.renderAttribute("durability",r.durability,i.durability,{isInteger:true});t+=v.renderAttribute("type",r.type,i.type,{isString:true,notIcon:true});return this.bodyTemplate({body:t,piece:e,name1:v.unescape(r.name),name2:v.unescape(i.name)})},renderPhysicalDefenses:function(e,t){var r="";e=e||{};t=t||{};r+=v.renderAttribute("regular_defense",e.regular,t.regular);r+=v.renderAttribute("strike_defense",e.strike,t.strike);r+=v.renderAttribute("slash_defense",e.slash,t.slash);r+=v.renderAttribute("thrust_defense",e.thrust,t.thrust);return r},renderElementalDefenses:function(e,t){var r="";e=e||{};t=t||{};r+=v.renderAttribute("fire_defense",e.fire,t.fire);r+=v.renderAttribute("magic_defense",e.magic,t.magic);r+=v.renderAttribute("lightning_defense",e.lightning,t.lightning);return r},renderResistances:function(e,t){var r="";e=e||{};t=t||{};r+=v.renderAttribute("bleed_resistance",e.bleed,t.bleed);r+=v.renderAttribute("poison_resistance",e.poison,t.poison);r+=v.renderAttribute("curse_resistance",e.curse,t.curse);return r},render:function(e,t){this.armor1=e;this.armor2=t;var r=this.renderSets();r+=this.renderPiece("Head");r+=this.renderPiece("Chest");r+=this.renderPiece("Hands");r+=this.renderPiece("Legs");this.$el.html(r)}});var b=Backbone.View.extend({initialize:function(){this.bodyTemplate=Handlebars.compile($("#armor-template").html())},renderStats:function(e,t){var r="";r+=v.renderAttribute("physical_damage",e.physical_damage,t.physical_damage);r+=v.renderAttribute("magic_damage",e.magic_damage,t.magic_damage);r+=v.renderAttribute("fire_damage",e.fire_damage,t.fire_damage);r+=v.renderAttribute("lightning_damage",e.lightning_damage,t.lightning_damage);r+=v.renderAttribute("critical",e.critical,t.critical);r+=v.renderAttribute("physical_reduction",e.physical_reduction,t.physical_reduction);r+=v.renderAttribute("magic_reduction",e.magic_reduction,t.magic_reduction);r+=v.renderAttribute("fire_reduction",e.fire_reduction,t.fire_reduction);r+=v.renderAttribute("lightning_reduction",e.lightning_reduction,t.lightning_reduction);r+=v.renderAttribute("stability",e.stability,t.stability);return r},renderParamBonus:function(e,t){var r="";r+=v.renderAttribute("strength",e.strength,t.strength,{isNegative:true});r+=v.renderAttribute("dexterity",e.dexterity,t.dexterity,{isNegative:true});r+=v.renderAttribute("intelligence",e.intelligence,t.intelligence,{isNegative:true});r+=v.renderAttribute("faith",e.faith,t.faith,{isNegative:true});return r},renderResistances:function(e,t){var r="";r+=v.renderAttribute("bleed_resistance",e.bleed,t.bleed,{isPercentage:true});r+=v.renderAttribute("poison_resistance",e.poison,t.poison,{isPercentage:true});r+=v.renderAttribute("toxic_resistance",e.toxic,t.toxic,{isPercentage:true});r+=v.renderAttribute("curse_resistance",e.curse,t.curse,{isPercentage:true});return r},renderAuxEffects:function(e,t){var r="";r+=v.renderAttribute("bleed",e.bleed,t.bleed,{isInteger:true});r+=v.renderAttribute("toxic",e.toxic,t.toxic,{isInteger:true});r+=v.renderAttribute("occult",e.occult,t.occult,{isInteger:true});r+=v.renderAttribute("divine",e.divine,t.divine,{isInteger:true});return r},render:function(e,t){var r=v.renderImage(e,t);r+=this.renderStats(e.stats,t.stats);r+=this.renderParamBonus(e.param_bonus,t.param_bonus);r+=this.renderParamBonus(e.req_param,t.req_param);if(e.resistances||t.resistances){r+=this.renderResistances(e.resistances,t.resistances)}if(e.aux_effect||t.aux_effect){r+=this.renderAuxEffects(e.aux_effect,t.aux_effect)}r+=v.renderAttribute("weight",e.weight,t.weight,{isNegative:true});r+=v.renderAttribute("durability",e.durability,t.durability,{isInteger:true});r+=v.renderAttribute("weapon_type",e.weapon_type,t.weapon_type,{isString:true,notIcon:true});r+=v.renderAttribute("attack_type",e.attack_type,t.attack_type,{isString:true,notIcon:true});content=this.bodyTemplate({body:r,piece:"Weapon",name1:e.name,name2:t.name});this.$el.html(content)}});var v=function(){var e=Handlebars.compile($("#attribute-template").html());var t=Handlebars.compile($("#image-template").html());var r=["-","S","A","B","C","D","E"];var i=function(e,t){if(e!==t){if(e==="S"){return 1}else if(t==="S"){return-1}else if(e==="-"||t==="-"){return 0}else{if(e>t)return 1;if(e<t)return-1}}else{return 0}};return{renderAttribute:function(t,n,a,s){n=n||"N/A";a=a||"N/A";s=s||{};var c=color2="",o="blue",l="red";if(!s.isString&&n!=="N/A"&&a!=="N/A"){if(s.isNegative){o="red";l="blue"}n=r.indexOf(n)>=0?n:parseFloat(n);a=r.indexOf(a)>=0?a:parseFloat(a);if(i(n,a)>0){c=o;color2=l}else if(i(n,a)<0){c=l;color2=o}if(!s.isInteger&&!s.isPercentage){n=r.indexOf(n)>=0?n:n.toFixed(1);a=r.indexOf(a)>=0?a:a.toFixed(1)}if(s.isPercentage){n=n+"%";a=a+"%"}}var u={key:t,icon:{icon:t,caption:t},color1:c,color2:color2,value1:n,value2:a};if(s.notIcon)delete u.icon;return e(u)},renderImage:function(e,r){return t({name1:unescape(e.name),name2:unescape(r.name),value1:e.image,value2:r.image})},unescape:function(e){e=unescape(e);e=e.replace("&#039;","'");return e}}}();